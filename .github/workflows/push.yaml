name: Push
run-name: ${{ github.ref_name }} push run ðŸš€
on:
  push:
    paths-ignore:
      - "**.md"
    branches:
      - master
      - "release/**"
    tags:
      - "*"
permissions:
  contents: write
jobs:
  build-project:
    name: Build ðŸ§±
    uses: ./.github/workflows/build-project.yaml
    secrets: inherit
    permissions:
      contents: read

  compatibility-validation:
    name: Validate Compatibility ðŸ•µï¸
    if: github.ref_name == 'master'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: plugins/win-capture/data/*.json

      - name: Check for Invalid Compatibility Data ðŸ“‰
        if: fromJSON(steps.checks.outputs.hasChangedFiles)
        uses: ./.github/actions/compatibility-validator
        with:
          repositorySecret: ${{ github.token }}

  services-validation:
    name: Validate Services ðŸ•µï¸
    if: github.ref_name == 'master'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Changed Files âœ…
        uses: ./.github/actions/check-changes
        id: checks
        with:
          baseRef: ${{ github.event.before }}
          checkGlob: plugins/rtmp-services/data/*.json

      - name: Check Services JSON Schema ðŸ“‰
        if: fromJSON(steps.checks.outputs.hasChangedFiles)
        uses: ./.github/actions/services-validator
        with:
          repositorySecret: ${{ github.token }}
          runSchemaChecks: true
          runServiceChecks: false

  create-release:
    name: Create Release ðŸ›«
    if: github.ref_type == 'tag'
    runs-on: ubuntu-24.04
    needs: [build-project]
    defaults:
      run:
        shell: bash
    steps:
      - name: Check Release Tag â˜‘ï¸
        id: check
        run: |
          : Check Release Tag â˜‘ï¸
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob

          case "${GITHUB_REF_NAME}" in
            +([0-9]).+([0-9]).+([0-9]) )
              echo 'validTag=true' >> $GITHUB_OUTPUT
              echo 'prerelease=false' >> $GITHUB_OUTPUT
              echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
              ;;
            +([0-9]).+([0-9]).+([0-9])-@(beta|rc)*([0-9]) )
              echo 'validTag=true' >> $GITHUB_OUTPUT
              echo 'prerelease=true' >> $GITHUB_OUTPUT
              echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
              ;;
            *) echo 'validTag=false' >> $GITHUB_OUTPUT ;;
          esac

      - name: Download Build Artifacts ðŸ“¥
        uses: actions/download-artifact@v4
        if: ${{ fromJSON(steps.check.outputs.validTag) }}

      - name: Rename Files ðŸ·ï¸
        if: fromJSON(steps.check.outputs.validTag)
        run: |
          : Rename Files ðŸ·ï¸
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi

          root_dir="${PWD}"

          commit_hash="${GITHUB_SHA:0:9}"
          macos_arm64_artifact_name="obs-studio-macos-arm64-${commit_hash}"
          macos_arm64_dsym_artifact_name="obs-studio-macos-arm64-${commit_hash}-dSYMs"
          macos_intel_artifact_name="obs-studio-macos-x86_64-${commit_hash}"
          macos_intel_dsym_artifact_name="obs-studio-macos-x86_64-${commit_hash}-dSYMs"
          ubuntu_2404_x86_64_artifact_name="obs-studio-ubuntu-24.04-x86_64-${commit_hash}"
          ubuntu_2404_x86_64_debug_name="obs-studio-ubuntu-24.04-x86_64-${commit_hash}-dbgsym"
          ubuntu_2404_sources_name="obs-studio-ubuntu-24.04-sources-${commit_hash}"
          windows_artifact_name="obs-studio-windows-x64-${{ steps.check.outputs.version }}-signed"
          windows_installer_name="obs-studio-windows-x64-${{ steps.check.outputs.version }}-installer"
          windows_debug_name="obs-studio-windows-x64-${{ steps.check.outputs.version }}-pdbs"

          echo '::group::Renaming Artifacts'
          mv -v "${ubuntu_2404_x86_64_artifact_name}/"obs-studio-*-x86_64-ubuntu-gnu.deb \
            "${root_dir}"/OBS-Studio-${{ steps.check.outputs.version }}-Ubuntu-24.04-x86_64.deb
          mv -v "${ubuntu_2404_x86_64_debug_name}/"obs-studio-*-x86_64-ubuntu-gnu-dbgsym.ddeb \
            "${root_dir}"/OBS-Studio-${{ steps.check.outputs.version }}-Ubuntu-24.04-x86_64-dbsym.ddeb
          mv -v "${ubuntu_2404_sources_name}/"obs-studio-*-sources.tar.gz \
            "${root_dir}"/OBS-Studio-${{ steps.check.outputs.version }}-Sources.tar.gz
          mv -v "${windows_artifact_name}/"OBS-Studio-*.zip \
            "${root_dir}"/OBS-Studio-${{ steps.check.outputs.version }}-Windows.zip
          mv -v "${windows_debug_name}/"OBS-Studio-*-pdbs.zip \
            "${root_dir}"/OBS-Studio-${{ steps.check.outputs.version }}-Windows-PDBs.zip
          echo '::endgroup::'

      - name: Generate Checksums ðŸªª
        if: fromJSON(steps.check.outputs.validTag)
        run: |
          : Generate Checksums ðŸªª
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob

          echo "### Checksums" > ${{ github.workspace }}/CHECKSUMS.txt
          for file in ${{ github.workspace }}/@(*.deb|*.ddeb|*.dmg|*.tar.xz|*.tar.gz|*.exe|*.zip); do
            echo "    ${file##*/}: $(sha256sum "${file}" | cut -d " " -f 1)" >> ${{ github.workspace }}/CHECKSUMS.txt
          done

      - name: Create Release ðŸ›«
        if: fromJSON(steps.check.outputs.validTag)
        id: create_release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191
        with:
          draft: true
          prerelease: ${{ fromJSON(steps.check.outputs.prerelease) }}
          tag_name: ${{ steps.check.outputs.version }}
          name: OBS Studio ${{ steps.check.outputs.version }}
          body_path: ${{ github.workspace }}/CHECKSUMS.txt
          files: |
            ${{ github.workspace }}/OBS-Studio-${{ steps.check.outputs.version }}-Ubuntu-*.deb
            ${{ github.workspace }}/OBS-Studio-${{ steps.check.outputs.version }}-Ubuntu-*.ddeb
            ${{ github.workspace }}/OBS-Studio-${{ steps.check.outputs.version }}-Sources.tar.gz
            ${{ github.workspace }}/OBS-Studio-${{ steps.check.outputs.version }}-Windows.zip
            ${{ github.workspace }}/OBS-Studio-${{ steps.check.outputs.version }}-Windows-PDBs.zip
